{% extends 'base.html' %}

{% block page_title %}Centro de Operaciones{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-3 col-6">
        <div class="small-box bg-info">
            <div class="inner">
                <h3 id="kpi-leads">0</h3>
                <p>Leads Detectados</p>
            </div>
            <div class="icon"><i class="ion ion-bag"></i></div>
        </div>
    </div>
    <div class="col-lg-3 col-6">
        <div class="small-box bg-success">
            <div class="inner">
                <h3>Bot<sup style="font-size: 20px">ON</sup></h3>
                <p>Estado del Sistema</p>
            </div>
            <div class="icon"><i class="ion ion-stats-bars"></i></div>
        </div>
    </div>
    <div class="col-lg-3 col-6">
        <div class="small-box bg-warning">
            <div class="inner">
                <h3 id="kpi-dms">0</h3>
                <p>DMs Enviados</p>
            </div>
            <div class="icon"><i class="ion ion-paper-airplane"></i></div>
        </div>
    </div>
    <div class="col-lg-3 col-6">
        <div class="small-box bg-danger">
            <div class="inner">
                <h3>MVP</h3>
                <p>Versi√≥n Actual</p>
            </div>
            <div class="icon"><i class="ion ion-pie-graph"></i></div>
        </div>
    </div>
</div>

<div class="row">
    
    <div class="col-lg-6">
        <div class="card card-primary card-tabs">
            <div class="card-header p-0 pt-1">
                <ul class="nav nav-tabs" id="custom-tabs-one-tab" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" id="tab-scrape-link" data-toggle="pill" href="#tab-scrape" role="tab">Miner√≠a</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="tab-comment-link" data-toggle="pill" href="#tab-comment" role="tab">Engagement (Config)</a>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content">
                    
                    <div class="tab-pane fade show active" id="tab-scrape" role="tabpanel">
                        <div class="form-group">
                            <label>Perfil Objetivo (Competencia)</label>
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text">@</span>
                                </div>
                                <input type="text" id="targetUsername" class="form-control" placeholder="Ej: nike">
                            </div>
                            <small class="text-muted">Extraeremos seguidores de esta cuenta.</small>
                        </div>
                        <div class="form-group">
                            <label>Cantidad a Extraer</label>
                            <input type="number" id="scrapeAmount" class="form-control" value="5" max="50">
                        </div>

                        <div class="form-check form-switch my-3">
                            <input class="form-check-input" type="checkbox" id="scrapingFastMode" name="use_fast_mode">
                            <label class="form-check-label" for="scrapingFastMode">
                                ‚ö° <strong>Activar Modo API (Fast Scraping)</strong>
                                <small class="d-block text-muted">
                                    Usa el Enjambre de Bots para extraer leads en segundos sin abrir navegador.
                                </small>
                            </label>
                        </div>

                        <button onclick="startScraping()" class="btn btn-warning btn-block font-weight-bold">
                            <i class="fas fa-search"></i> EXTRAER LEADS AHORA
                        </button>
                    </div>

                    <div class="tab-pane fade" id="tab-comment" role="tabpanel">
                        <div class="form-group">
                            <label>URL del Post / Reel</label>
                            <input type="text" id="postUrl" class="form-control" placeholder="https://instagram.com/p/...">
                        </div>
                        
                        <label>¬øQu√© acciones realizar?</label>
                        <div class="row mb-3">
                            <div class="col-4">
                                <div class="custom-control custom-checkbox">
                                    <input class="custom-control-input" type="checkbox" id="checkLike" checked>
                                    <label for="checkLike" class="custom-control-label">Dar Like</label>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="custom-control custom-checkbox">
                                    <input class="custom-control-input" type="checkbox" id="checkComment" checked>
                                    <label for="checkComment" class="custom-control-label">Comentar</label>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="custom-control custom-checkbox">
                                    <input class="custom-control-input" type="checkbox" id="checkSave">
                                    <label for="checkSave" class="custom-control-label">Guardar</label>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Estilo de Comentario (Personalidad)</label>
                            <select id="aiPersonaSelect" class="form-control" onchange="toggleCustomPersona()">
                                <option value="Sarc√°stico y Divertido">Sarc√°stico / Divertido</option>
                                <option value="Profesional y Serio">Profesional / Experto</option>
                                <option value="Amigable y Emojis">Amigable / Fan</option>
                                <option value="Hater Suave">Cr√≠tico / Pol√©mico</option>
                                <option value="custom">Personalizado (Escribir abajo)</option>
                            </select>
                        </div>

                        <div class="form-group" id="customPersonaGroup" style="display:none;">
                            <label>Describe la personalidad:</label>
                            <textarea id="aiPersonaCustom" class="form-control" rows="2" placeholder="Ej: Habla formal, breve y sin emojis..."></textarea>
                        </div>

                        <div class="form-group">
                            <label>Prompt del Comentario (opcional)</label>
                            <textarea id="aiCustomPrompt" class="form-control" rows="3" placeholder="Escribe aqu√≠ tu prompt personalizado para que el bot genere el comentario (ej: 'Comenta resaltando beneficios, sin emojis y con tono profesional')."></textarea>
                            <small class="text-muted">Si completas este campo, tendr√° prioridad sobre la plantilla autom√°tica.</small>
                        </div>
                        <div class="form-group">
                            <div class="custom-control custom-switch">
                                <input type="checkbox" class="custom-control-input" id="engineSwitch">
                                <label class="custom-control-label" for="engineSwitch">
                                    ‚ö° Activar Modo API (R√°pido, sin navegador)
                                </label>
                            </div>
                            <small class="text-muted">Desactivado = Simulaci√≥n Humana (Selenium). Activado = Instagrapi.</small>
                        </div>

                        <button onclick="startCommentBot()" class="btn btn-success btn-block font-weight-bold">
                            <i class="fas fa-rocket"></i> EJECUTAR ACCIONES
                        </button>
                    </div>

                </div>
            </div>
        </div>

        <div class="card card-dark mt-3">
            <div class="card-header">
                <h3 class="card-title"><i class="fas fa-terminal"></i> Logs del Sistema</h3>
            </div>
            <div class="card-body bg-black" style="height: 150px; overflow-y: auto; font-family: monospace; color: #00ff00; font-size: 0.9em;">
                <div id="logConsole">
                    <span class="text-muted">> Esperando √≥rdenes...</span><br>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-6">
        <div class="card card-outline card-success">
            <div class="card-header">
                <h3 class="card-title">Base de Datos de Leads</h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-tool" onclick="loadLeads()">
                        <i class="fas fa-sync-alt"></i> Recargar Tabla
                    </button>
                </div>
            </div>
            <div class="card-body table-responsive p-0" style="height: 400px;">
                <table class="table table-head-fixed text-nowrap">
                    <thead>
                        <tr>
                            <th>Usuario</th>
                            <th>Estado</th>
                            <th>Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody id="leadsTableBody">
                        <tr><td colspan="3" class="text-center text-muted">Cargando datos...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const ACCOUNT_ID = "{{ account_id }}"; 

    // --- UTILIDADES ---
    function log(msg) {
        const consoleDiv = document.getElementById('logConsole');
        const time = new Date().toLocaleTimeString();
        consoleDiv.innerHTML += `[${time}] ${msg}<br>`;
        consoleDiv.scrollTop = consoleDiv.scrollHeight;
    }

    function toggleCustomPersona() {
        const val = document.getElementById('aiPersonaSelect').value;
        const customGroup = document.getElementById('customPersonaGroup');
        customGroup.style.display = (val === 'custom') ? 'block' : 'none';
    }

    // --- 1. SCRAPING ---
    function cleanUsername(input) {
        if (input.includes('instagram.com/')) {
            return input.split('instagram.com/')[1].split('/')[0].split('?')[0];
        }
        return input;
    }

    function startScraping() {
        let rawTarget = document.getElementById('targetUsername').value;
        const amount = document.getElementById('scrapeAmount').value;
        // NUEVO: Capturamos el checkbox
        const useFastMode = document.getElementById('scrapingFastMode').checked;

        if(!rawTarget) return alert("Escribe un usuario objetivo");
        const target = cleanUsername(rawTarget);
        
        const modeLabel = useFastMode ? "‚ö° API R√°pida" : "üê¢ Visual (Selenium)";
        log(`Iniciando scraping en @${target} (${amount} leads) v√≠a ${modeLabel}...`);
        
        fetch(`/api/account/${ACCOUNT_ID}/start-scraping/`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify({ 
                target_username: target, 
                amount: amount,
                use_fast_mode: useFastMode // Enviamos el par√°metro al Backend
            })
        })
        .then(res => res.json())
        .then(data => {
            if(data.status) log(`Tarea Scraping encolada: ${data.task_id || data.detail}`);
            else log(`Error: ${data.error || data.detail}`);
        })
        .catch(err => log(`Error Red: ${err}`));
    }

    // --- 2. BOT DE ENGAGEMENT (CONECTADO A CHECKBOXES) ---
    // --- 2. BOT DE ENGAGEMENT (CONECTADO A CHECKBOXES) ---
    function startCommentBot() {
        const url = document.getElementById('postUrl').value;
        
        // Obtener Personalidad
        let persona = document.getElementById('aiPersonaSelect').value;
        if(persona === 'custom') {
            persona = document.getElementById('aiPersonaCustom').value;
        }

        // Prompt personalizado (opcional)
        const customPrompt = document.getElementById('aiCustomPrompt').value;

        // Obtener Checkboxes (Acciones)
        const doLike = document.getElementById('checkLike').checked;
        const doComment = document.getElementById('checkComment').checked;
        const doSave = document.getElementById('checkSave').checked;
        const useFastMode = document.getElementById('engineSwitch').checked;

        if(!url) return alert("Falta URL del post");
        if(doComment && !persona) return alert("Selecciona una personalidad para comentar");
        if(!doLike && !doComment && !doSave) return alert("¬°Selecciona al menos una acci√≥n!");

        log(`Iniciando interacci√≥n...`);
        log(`Config: Like=${doLike}, Comentar=${doComment}, Guardar=${doSave}`);

        fetch(`/api/account/${ACCOUNT_ID}/start-bot/`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify({ 
                post_url: url, 
                user_persona: persona,
                do_like: doLike,
                do_comment: doComment,
                do_save: doSave,
                user_prompt: customPrompt,
                use_fast_mode: useFastMode
            })
        })
        .then(res => {
            if (!res.ok) return res.text().then(text => { throw new Error(text) });
            return res.json();
        })
        .then(data => {
            if(data.status) log(`Tarea Engagement ID: ${data.task_id}`);
            else log(` Error: ${data.error || data.detail}`);
        })
        .catch(err => {
            console.error(err);
            let msg = err.message;
            if (msg.includes('<!DOCTYPE html>')) msg = "Error 500: Revisa la Terminal de Django";
            log(` Error Critico: ${msg}`);
        });
    }

    // --- 3. CARGAR LEADS ---
    function loadLeads() {
        fetch(`/api/account/${ACCOUNT_ID}/leads/`)
        .then(res => {
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            return res.json();
        })
        .then(data => {
            const tbody = document.getElementById('leadsTableBody');
            tbody.innerHTML = ''; 
            
            if(Array.isArray(data)) document.getElementById('kpi-leads').innerText = data.length;

            if(!Array.isArray(data) || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center">No hay leads. ¬°Usa Miner√≠a!</td></tr>';
                return;
            }

            data.forEach(lead => {
                let badgeClass = lead.status === 'contacted' ? 'badge-success' : 'badge-warning';
                
                let actionHtml = '';
                if(lead.status === 'to_contact') {
                    // ID con comillas simples para evitar error de sintaxis
                    actionHtml = `<button class="btn btn-sm btn-primary" onclick="sendDM('${lead.id}', '${lead.ig_username}')">
                                    <i class="fas fa-paper-plane"></i> Enviar DM
                                  </button>`;
                } else {
                    actionHtml = `<span class="text-muted"><i class="fas fa-check-double"></i> Enviado</span>`;
                }

                const row = `
                    <tr>
                        <td><b>@${lead.ig_username}</b></td>
                        <td><span class="badge ${badgeClass}">${lead.status}</span></td>
                        <td>${actionHtml}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
            log("Tabla actualizada.");
        })
        .catch(err => {
            log(`Error Leads: ${err.message}`);
            document.getElementById('leadsTableBody').innerHTML = '<tr><td colspan="3" class="text-danger text-center">Error cargando datos</td></tr>';
        });
    }

    function sendDM(leadId, username) {
        if(!confirm(`¬øSeguro que quieres enviar DM a @${username}?`)) return;
        log(`Enviando DM a @${username}...`);
        
        fetch(`/api/account/${ACCOUNT_ID}/start-outreach/`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify({ lead_id: leadId })
        })
        .then(res => res.json())
        .then(data => {
            if(data.status) {
                log(`Tarea Outreach encolada.`);
                setTimeout(loadLeads, 2000); 
            } else {
                log(`Error: ${data.error || data.detail}`);
            }
        });
    }

    document.addEventListener('DOMContentLoaded', loadLeads);
</script>
{% endblock %}